<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>英単語クイズ</title>

  <!-- PWA マニフェスト -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Markdown パーサー -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-family: sans-serif;
      background: #f9f9f9;
      color: #333;
    }
    header, footer {
      background: #fff;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    .data {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      min-height: 0; /* 追加 */
    }
    .question-container {
      margin-bottom: 1rem;
    }
    .answer-container {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: #fff;
      border-radius: 4px;
    }
    .slideshow-container {
      position: relative;
      max-width: 100%;
      margin-bottom: 1rem;
    }
    .slides {
      display: none;
      text-align: center;
    }
    .slides img, .slides video {
      max-width: 100%;
      max-height: 60vh;
      border-radius: 4px;
    }
    .prev, .next {
      cursor: pointer;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 0.5rem;
      border: none;
      border-radius: 50%;
    }
    .prev { left: 10px; }
    .next { right: 10px; }
    .controls {
      display: flex;
      justify-content: space-around;
      margin-top: auto;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-next {
      background: #4caf50;
      color: #fff;
    }
    .btn-answer {
      background: #2196f3;
      color: #fff;
    }
    .btn-learned {
      background: #ff9800;
      color: #fff;
    }
  </style>
</head>
<body>
  <header>
    <h1>英単語クイズ</h1>
  </header>
  <main>
    <div class="data">
      <div class="question-container">
        <p id="name">問題: </p>
      </div>
      <div id="text" class="answer-container">解答: </div>
      <div class="slideshow-container">
        <div class="slides" id="slides"></div>
        <button class="prev" id="prevBtn">&#10094;</button>
        <button class="next" id="nextBtn">&#10095;</button>
      </div>
      <div class="controls">
        <button id="learnedBtn" class="btn-learned" disabled>覚えた！</button>
        <button id="answerBtn" class="btn-answer" disabled>解答</button>
        <button id="nextBtnMain" class="btn-next">問題</button>
      </div>
    </div>
  </main>
  <footer>
    <a id="sourceLink" href="#" target="_blank">問題元リンク</a>
    <p>学習回数: <span id="learnCount">0</span></p>
  </footer>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }

    const nameEl = document.getElementById('name');
    const textEl = document.getElementById('text');
    const slidesEl = document.getElementById('slides');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const learnedBtn = document.getElementById('learnedBtn');
    const answerBtn = document.getElementById('answerBtn');
    const nextBtnMain = document.getElementById('nextBtnMain');
    const learnCountEl = document.getElementById('learnCount');
    const sourceLink = document.getElementById('sourceLink');

    let currentRow;
    let currentSlideIndex = 0;

    nextBtnMain.addEventListener('click', async () => {
      const res = await fetch('/get-random-row');
      currentRow = await res.json();
      nameEl.textContent = `問題: ${currentRow.word}`;
      textEl.innerHTML = '解答: ';
      slidesEl.innerHTML = '';
      learnCountEl.textContent = currentRow.learn_count;
      sourceLink.href = currentRow.source_url;
      answerBtn.disabled = false;
      learnedBtn.disabled = true;
      currentSlideIndex = 0;
    });

    answerBtn.addEventListener('click', () => {
      textEl.innerHTML = marked(currentRow.definition || '');
      preloadMedia();
      showSlide(0);
      answerBtn.disabled = true;
      learnedBtn.disabled = false;
    });

    learnedBtn.addEventListener('click', async () => {
      const res = await fetch('/update-learning-count', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: currentRow.id })
      });
      const data = await res.json();
      learnCountEl.textContent = data.learn_count;
      learnedBtn.disabled = true;
    });

    prevBtn.addEventListener('click', () => showSlide(currentSlideIndex - 1));
    nextBtn.addEventListener('click', () => showSlide(currentSlideIndex + 1));

    function preloadMedia() {
      slidesEl.innerHTML = '';
      (currentRow.slides || []).forEach(item => {
        const slideContainer = document.createElement('div');
        slideContainer.className = 'slides';
        if (item.type === 'image') {
          const img = document.createElement('img');
          img.src = item.url;
          slideContainer.appendChild(img);
        } else if (item.type === 'video') {
          const video = document.createElement('video');
          video.src = item.url;
          video.controls = true;
          slideContainer.appendChild(video);
        }
        slidesEl.appendChild(slideContainer);
      });
    }

    function showSlide(index) {
      const slides = slidesEl.querySelectorAll('.slides');
      if (slides.length === 0) return;
      if (index < 0) index = slides.length - 1;
      if (index >= slides.length) index = 0;
      slides.forEach(s => s.style.display = 'none');
      slides[index].style.display = 'block';
      currentSlideIndex = index;
    }
  </script>
</body>
</html>
